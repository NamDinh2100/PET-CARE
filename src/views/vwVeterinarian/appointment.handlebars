{{#section 'css'}}
<style>
    /* Status Badge Styling */
    .status-badge {
        min-width: 100px;
        padding: 8px 12px;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-size: 0.75rem;
    }

    /* Confirmed - Blue */
    .status-confirmed {
        background-color: #e7f1ff;
        color: #0d6efd;
        border: 1px solid #0d6efd;
    }

    /* Completed - Green */
    .status-completed {
        background-color: #e8f5e9;
        color: #198754;
        border: 1px solid #198754;
    }

    /* Cancelled - Red */
    .status-cancelled {
        background-color: #ffe5e5;
        color: #dc3545;
        border: 1px solid #dc3545;
    }

    /* Pending - Orange */
    .status-pending {
        background-color: #fff3cd;
        color: #fd7e14;
        border: 1px solid #fd7e14;
    }

    /* Scheduled - Purple */
    .status-scheduled {
        background-color: #f3e8ff;
        color: #6f42c1;
        border: 1px solid #6f42c1;
    }

    /* Modal Styling */
    .modal-content {
        border: 3px solid #2d5bff;
        border-radius: 25px;
    }

    .modal-header {
        background-color: #2d5bff;
        color: white;
        border-bottom: 3px solid #2d5bff;
        border-radius: 22px 22px 0 0;
        text-align: center;
    }

    .modal-header .modal-title {
        width: 100%;
        text-align: center;
    }

    .modal-header .btn-close,
    .modal-header .btn-close:hover,
    .modal-header .btn-close:focus {
        background: transparent;
        border: 2px solid white;
        color: white;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s ease;
        position: relative;
    }

    .modal-header .btn-close:hover {
        background: rgba(220, 53, 69, 0.8);
        border-color: #dc3545;
    }

    .modal-header .btn-close::before {
        content: "×";
        color: white;
        font-size: 20px;
        line-height: 1;
    }

    .modal-backdrop.show {
        backdrop-filter: blur(5px);
        opacity: 0.5;
    }

    .table-container {
        min-height: 450px;
    }

    /* Pagination Styling */
    .pagination .page-link {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        padding: 0;
        border: 2px solid #0d6efd;
        color: #0d6efd;
        margin: 0 3px;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
    }
    .pagination .page-link:hover:not(.disabled) {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
        transform: translateY(-1px);
    }
    .pagination .page-item.disabled .page-link {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Page Size Selector */
    .form-select-sm {
        padding: 0.375rem 2rem 0.375rem 0.75rem;
        font-size: 0.875rem;
    }

    /* Advanced Search Styling */
    .search-form .form-select {
        border-right: none;
        font-weight: 600;
        background-color: #f8f9fa;
    }

    .search-form .form-control {
        border-left: none;
        border-radius: 0 25px 25px 0 !important;
    }

    .search-form .input-group-prepend .form-select {
        border-radius: 25px 0 0 25px !important;
    }

    .search-input-rounded {
        border-radius: 0 25px 25px 0;
    }
</style>
{{/section}}

{{!-- Advanced Search Section --}}
<div class="row mb-4">
    <div class="col-md-10 mx-auto">
        <form action="/vet/appointment" method="GET" class="search-form">
            <div class="input-group">
                <div class="input-group-prepend">
                    <select name="field" class="form-select border-dark" style="min-width: 180px; max-width: 180px; border-top-right-radius: 0; border-bottom-right-radius: 0;">
                        <option value="all" {{#if (eq searchField 'all')}}selected{{/if}}>All Fields</option>
                        <option value="id" {{#if (eq searchField 'id')}}selected{{/if}}>ID</option>
                        <option value="customer" {{#if (eq searchField 'customer')}}selected{{/if}}>Customer</option>
                    </select>
                </div>
                <input type="text" name="q" class="form-control border-dark search-input-rounded ps-4 bg-white"
                    placeholder="SEARCH APPOINTMENTS..." aria-label="Search" value="{{searchQuery}}">
                <button type="submit" class="position-absolute end-0 top-50 translate-middle-y me-3 z-1 cursor-pointer text-secondary btn btn-link p-0">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            {{#if isSearchMode}}
            <div class="mt-2">
                <span class="badge bg-info me-2">
                    <i class="bi bi-search me-1"></i>
                    Search: "{{searchQuery}}" in 
                    {{#if (eq searchField 'all')}}All Fields{{/if}}
                    {{#if (eq searchField 'id')}}ID{{/if}}
                    {{#if (eq searchField 'customer')}}Customer{{/if}}
                </span>
                <a href="/vet/appointment" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-x me-1"></i>Clear Search
                </a>
            </div>
            {{/if}}
        </form>
    </div>
</div>

<div class="card shadow-sm border-0 rounded-4">
    <div class="card-body p-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-0 brand-font fw-bold text-uppercase">Appointments</h4>
                {{#if isSearchMode}}
                <small class="text-muted">
                    {{schedule.length}} result(s) found for "{{searchQuery}}"
                    {{#unless (eq searchField 'all')}}
                        in {{#if (eq searchField 'customer')}}Customer{{/if}}{{#if (eq searchField 'id')}}ID{{/if}}{{#if (eq searchField 'status')}}Status{{/if}}
                    {{/unless}}
                </small>
                {{/if}}
            </div>
            
            <div class="d-flex align-items-center gap-3">
                {{!-- Status Filter Dropdown --}}
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-funnel me-1"></i>
                        {{#if currentStatus}}
                            {{#if (eq currentStatus 'confirmed')}}Confirmed{{/if}}
                            {{#if (eq currentStatus 'completed')}}Completed{{/if}}
                            {{#if (eq currentStatus 'cancelled')}}Cancelled{{/if}}
                            {{#if (eq currentStatus 'scheduled')}}Scheduled{{/if}}
                        {{else}}All Status{{/if}}
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item {{#unless currentStatus}}active{{/unless}}"
                                href="/vet/appointment">All Status</a></li>
                        <li><a class="dropdown-item {{#if (eq 'confirmed' currentStatus)}}active{{/if}}"
                                href="/vet/appointment?status=confirmed">Confirmed</a></li>
                        <li><a class="dropdown-item {{#if (eq 'completed' currentStatus)}}active{{/if}}"
                                href="/vet/appointment?status=completed">Completed</a></li>

            
                    </ul>
                </div>
            </div>
        </div>

        <div class="table-responsive table-container">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col" class="ps-3 py-3 rounded-start-3">Customer</th>
                        <th scope="col" class="py-3">Date</th>
                        <th scope="col" class="py-3">Status</th>
                        <th scope="col" class="text-end pe-3 py-3 rounded-end-3">Actions</th>
                    </tr>
                </thead>
                <tbody id="appointmentTableBody">
                    {{#if schedule.length}}
                    {{#each schedule}}
                    <tr>
                        <td class="ps-3 fw-semibold">{{this.customer_name}}</td>
                        <td class="format-date-cell" data-raw="{{this.date_start}}">
                            {{this.date_start}}
                        </td>
                        
                        <td>
                            <span class="badge rounded-pill status-badge status-{{this.status}}">
                                {{this.status}}
                            </span>
                        </td>
                        
                        <td class="text-end pe-3">

                            {{#unless (eq this.status "completed")}}
                            <button class="btn btn-outline-success btn-sm px-3 py-1 me-2" data-bs-toggle="modal"
                                data-bs-target="#prescriptionModal"
                                data-id="{{this.appointment_id}}"
                                data-pet-id="{{this.pet_id}}">
                                Prescription
                            </button>
                            {{/unless}}

                            {{#if (eq this.pet_id null)}}
                                <a href="/vet/appointment/pet-info?customer_id={{this.customer_id}}&appointment_id={{this.appointment_id}}" 
                                    class="btn btn-outline-dark btn-sm px-3 py-1 me-2">
                                    Details
                                </a>
                            {{else}}
                                <a href="/vet/appointment/pet-info?pet_id={{this.pet_id}}" 
                                    class="btn btn-outline-dark btn-sm px-3 py-1 me-2">
                                    Details
                                </a>
                            {{/if}}
                            <button class="btn btn-outline-primary btn-sm px-3 py-1" data-bs-toggle="modal"
                                data-bs-target="#receptionModal" 
                                data-id="{{this.appointment_id}}"
                                data-pet-id="{{this.pet_id}}"
                                data-customer="{{this.customer_name}}" 
                                data-date="{{this.date_start}}"
                                data-time="{{this.time}}" 
                                data-note="{{this.note}}"
                                data-services='{{#if this.services}}{{json this.services}}{{else}}[]{{/if}}'
                                >
                                Reception
                            </button>
                        </td>
                    </tr>
                    {{/each}}
                    {{else}}
                    <tr>
                        <td colspan="4" class="text-center py-5 text-muted">No appointments found</td>
                    </tr>
                    {{/if}}
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4">
            {{!-- Page Size Selector --}}
            <div class="d-flex align-items-center">
                <span class="text-muted me-2">Show:</span>
                <form method="GET" action="/vet/appointment" class="d-inline">
                    {{!-- Preserve current search and filter parameters --}}
                    {{#if searchQuery}}
                    <input type="hidden" name="q" value="{{searchQuery}}">
                    <input type="hidden" name="field" value="{{searchField}}">
                    {{/if}}
                    {{#if currentStatus}}
                    <input type="hidden" name="status" value="{{currentStatus}}">
                    {{/if}}
                    <select name="limit" onchange="this.form.submit()" class="form-select form-select-sm border-2" style="width: auto;">
                        <option value="10" {{#if (eq pagination.limit 10)}}selected{{/if}}>10</option>
                        <option value="25" {{#if (eq pagination.limit 25)}}selected{{/if}}>25</option>
                        <option value="50" {{#if (eq pagination.limit 50)}}selected{{/if}}>50</option>
                        <option value="100" {{#if (eq pagination.limit 100)}}selected{{/if}}>100</option>
                    </select>
                </form>
                <span class="text-muted ms-2">entries</span>
            </div>

            {{!-- Pagination Info --}}
            <div class="text-muted">
                Showing {{pagination.from}} to {{pagination.to}} of {{pagination.total}} entries
                {{#if isSearchMode}}
                    (filtered from {{pagination.totalRecords}} total entries)
                {{/if}}
            </div>

            {{!-- Pagination Navigation --}}
            {{#if (gt pagination.totalPages 1)}}
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    {{!-- First Page --}}
                    {{#if (gt pagination.currentPage 1)}}
                    <li class="page-item">
                        <a class="page-link" href="{{pagination.firstPageUrl}}" title="First Page">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    {{/if}}

                    {{!-- Previous Page --}}
                    {{#if pagination.hasPrevious}}
                    <li class="page-item">
                        <a class="page-link" href="{{pagination.prevPageUrl}}" title="Previous Page">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    {{/if}}

                    {{!-- Page Numbers --}}
                    {{#each pagination.pageNumbers}}
                    <li class="page-item {{#if this.isCurrent}}active{{/if}} {{#if this.isDisabled}}disabled{{/if}}">
                        {{#if this.isEllipsis}}
                            <span class="page-link">...</span>
                        {{else}}
                            <a class="page-link" href="{{this.url}}">{{this.number}}</a>
                        {{/if}}
                    </li>
                    {{/each}}

                    {{!-- Next Page --}}
                    {{#if pagination.hasNext}}
                    <li class="page-item">
                        <a class="page-link" href="{{pagination.nextPageUrl}}" title="Next Page">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    {{/if}}

                    {{!-- Last Page --}}
                    {{#if (lt pagination.currentPage pagination.totalPages)}}
                    <li class="page-item">
                        <a class="page-link" href="{{pagination.lastPageUrl}}" title="Last Page">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                    {{/if}}
                </ul>
            </nav>
            {{/if}}
        </div>

    </div>
</div>

{{!-- Reception Modal --}}
<div class="modal fade" id="receptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-uppercase text-white" style="font-family: 'Abhaya Libre', serif;">Reception</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
                    
            <div class="modal-body p-4">
                <form>
                    <input type="hidden" id="receptionId">
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="fw-bold small text-uppercase mb-1">Customer</label>
                            <input type="text" class="form-control border-2 rounded-3" id="receptionCustomer" readonly>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="fw-bold small text-uppercase mb-1">Time</label>
                            <input type="text" class="form-control border-2 rounded-3" id="receptionTime" readonly>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="fw-bold small text-uppercase mb-1">Date Start</label>
                            <input type="text" class="form-control border-2 rounded-3" id="receptionDate" readonly>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="fw-bold small text-uppercase mb-1">Service</label>
                            <textarea class="form-control border-2 rounded-3" id="receptionService" rows="3" readonly></textarea>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="fw-bold small text-uppercase mb-1">Note</label>
                        <textarea class="form-control border-2 rounded-3" id="receptionNote" rows="1" readonly></textarea>
                    </div>
                    
                    
                </form>
            </div>
        </div>
    </div>
</div>

{{!-- Prescription Modal --}}
<div class="modal fade" id="prescriptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-uppercase text-white" style="font-family: 'Abhaya Libre', serif;">Prescription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body p-4">
                <form method="POST" action="/vet/appointment/prescription">
                    
                    <input type="hidden" id="prescriptionAppointmentId" name="appointment_id" value="">
                    <input type="hidden" id="prescriptionPetId" name="pet_id" value="">

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label class="fw-bold small text-uppercase mb-1">Symptom</label>
                                    <input type="text" name="symptoms" class="form-control border-2 rounded-3">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label class="fw-bold small text-uppercase mb-1">Diagnosis</label>
                                    <input type="text" name="diagnosis" class="form-control border-2 rounded-3">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="fw-bold small text-uppercase">Medicine</label>
                            {{#if medicines.length}}
                            <div style="border: 2px solid #dee2e6; border-radius: 15px; padding: 20px; background-color: #fff; max-height: 150px; overflow-y: auto;">
                                {{#each medicines}}
                                <div class="form-check" style="margin-left: 0; padding-left: 1.25em;">
                                    <input class="form-check-input" type="checkbox" name="medicine_id" value="{{this.medicine_id}}"
                                        id="medicine_{{this.medicine_id}}" style="margin-left: -1.25em;">
                                    <label class="form-check-label fw-bold" for="medicine_{{this.medicine_id}}">
                                        {{this.medicine_name}}
                                    </label>
                                </div>
                                {{/each}}
                            </div>
                            {{else}}
                            <div class="alert alert-warning">No medicines available.</div>
                            {{/if}}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="fw-bold small text-uppercase mb-1">Treatment</label>
                        <textarea name="treatment" class="form-control border-2 rounded-3" rows="1"></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="fw-bold small text-uppercase mb-1">Instruction</label>
                        <textarea name="instruction" class="form-control border-2 rounded-3" rows="1"></textarea>
                    </div>
                    
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary border-2 rounded-pill fw-bold px-4 text-uppercase">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


{{#section 'js'}}
<script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // Handle prescription form
    const prescriptionForm = document.querySelector('form[action*="prescription"]');
    if (prescriptionForm) {
        prescriptionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            Swal.fire({
                title: 'Success!',
                text: 'Prescription saved successfully.',
                icon: 'success',
                confirmButtonText: 'OK'
            }).then(() => {
                e.target.submit();
            });
        });
    }

    // Hàm hỗ trợ format ngày từ chuỗi ISO -> dd/mm/yyyy
    function formatISODateToDisplay(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        if (isNaN(date)) return isoString; 
        
        return date.toLocaleDateString('en-GB'); 
    }

    // Hàm hỗ trợ format giờ (bỏ giây: 10:00:00 -> 10:00)
    function formatTimeString(timeString) {
        if (!timeString) return '';
        if (timeString.length >= 5) {
            return timeString.substring(0, 5);
        }
        return timeString;
    }

    document.addEventListener('DOMContentLoaded', () => {
        
        // 1. XỬ LÝ HIỂN THỊ DATE TRÊN BẢNG (TABLE)
        const dateCells = document.querySelectorAll('.format-date-cell');
        dateCells.forEach(cell => {
            const rawDate = cell.getAttribute('data-raw');
            cell.textContent = formatISODateToDisplay(rawDate);
        });

        // 2. XỬ LÝ HIỂN THỊ DỮ LIỆU TRONG MODAL RECEPTION
        const receptionModal = document.getElementById('receptionModal');
        if (receptionModal) {
            receptionModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;

                const id = button.getAttribute('data-id');
                const customer = button.getAttribute('data-customer');
                const rawDate = button.getAttribute('data-date');
                const rawTime = button.getAttribute('data-time');
                const note = button.getAttribute('data-note');
                const rawServices = button.getAttribute('data-services');

                // Xử lý Services (Hiển thị mỗi service trên một dòng)
                let serviceText = '';
                try {
                    const servicesArray = JSON.parse(rawServices);
                    if (Array.isArray(servicesArray) && servicesArray.length > 0) {
                        // Nối các tên dịch vụ lại, mỗi dịch vụ một dòng mới
                        serviceText = servicesArray.map(s => s.service_name).join('\n');
                    }
                } catch (e) {
                    serviceText = 'Lỗi dữ liệu dịch vụ';
                }

                // Điền vào các ô input trong modal
                const modal = receptionModal;
                modal.querySelector('#receptionId').value = id || '';
                modal.querySelector('#receptionCustomer').value = customer || '';
                modal.querySelector('#receptionNote').value = note || '';
                modal.querySelector('#receptionService').value = serviceText;   

                // Format và điền Date & Time
                modal.querySelector('#receptionDate').value = formatISODateToDisplay(rawDate);
                modal.querySelector('#receptionTime').value = formatTimeString(rawTime);
            });
        }

        // 2.5 XỬ LÝ HIỂN THỊ DỮ LIỆU TRONG MODAL PRESCRIPTION
        const prescriptionModal = document.getElementById('prescriptionModal');
        if (prescriptionModal) {
            prescriptionModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;

                const appointmentId = button.getAttribute('data-id');
                const petId = button.getAttribute('data-pet-id');

                // Điền vào các hidden input trong form prescription
                prescriptionModal.querySelector('#prescriptionAppointmentId').value = appointmentId || '';
                prescriptionModal.querySelector('#prescriptionPetId').value = petId || '';
            });
        }
    });
</script>
{{/section}}