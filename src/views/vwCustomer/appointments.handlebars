{{#section 'css'}}
<style>
    body {
        background-color: #f4f7f6;
        font-family: 'Abhaya Libre', serif;
    }

    /* Content Styles */
    .content-section {
        background: white;
        border-radius: 20px;
        border: 2px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-top: 30px;
        margin-bottom: 40px;
        overflow: hidden;
    }

    .content-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 15px 25px;
        border-bottom: 2px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .content-title {
        font-family: 'Abhaya Libre', serif;
        font-size: 1.1rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #212529;
    }

    .header-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-select {
        border: 1.5px solid #495057;
        border-radius: 6px;
        padding: 5px 28px 5px 10px;
        font-size: 0.8rem;
        font-weight: 500;
        width: auto;
        height: 32px;
        background-color: white;
        cursor: pointer;
    }

    .filter-select:focus {
        border-color: #212529;
        box-shadow: none;
    }

    .btn-book-new {
        padding: 5px 12px;
        font-size: 0.8rem;
        font-weight: 600;
        border-radius: 6px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .content-body {
        padding: 30px;
    }

    /* Table Styles */
    .custom-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .custom-table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #212529;
        padding: 15px;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.85rem;
        color: #212529;
    }

    .custom-table tbody td {
        padding: 15px;
        vertical-align: middle;
        border-bottom: 1px solid #eee;
    }

    
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        border: 1px solid transparent;
    }

    .status-scheduled { background: #fff3cd; color: #856404; border-color: #ffeeba; }
    .status-confirmed { background: #d4edda; color: #155724; border-color: #c3e6cb; }
    .status-completed { background: #cce5ff; color: #004085; border-color: #b8daff; }
    .status-cancelled { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }

    .btn-action {
        width: 35px;
        height: 35px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        transition: all 0.2s;
        border: 2px solid #212529;
    }

    .btn-edit { color: #212529; background: white; }
    .btn-edit:hover { background: #212529; color: white; }
    .btn-delete { color: #dc3545; background: white; border-color: #dc3545; }
    .btn-delete:hover { background: #dc3545; color: white; }

    
    /* Modal Styles */
    .modal-content-custom {
        border-radius: 20px;
        border: 3px solid #2d5bff;
        overflow: hidden;
    }

    .modal-header-custom {
        background: #2d5bff;
        border-bottom: 3px solid #2d5bff;
        padding: 20px 30px;
        border-radius: 0px 0px 0 0;
        text-align: center;
    }

    .modal-header-custom .modal-title-custom {
        width: 100%;
        text-align: center;
    }

    .modal-title-custom {
        font-family: 'Abhaya Libre', serif;
        font-weight: 800;
        text-transform: uppercase;
        color: white;
    }

    .btn-close-custom {
        background: #dc3545;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: none;
    }

    .btn-close-custom:hover,
    .btn-close-custom:focus {
        background: #dc3545;
        box-shadow: none;
        color: white;
    }

    /* Pagination */
    .pagination-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
    }

    .pagination-btn {
        border: 2px solid #dee2e6;
        background: white;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .pagination-btn:hover {
        border-color: #212529;
        background: #f8f9fa;
    }

    .pagination-btn.active {
        background: #212529;
        color: white;
        border-color: #212529;
    }

    .pagination-info {
        font-size: 0.9rem;
        color: #6c757d;
        margin-left: 10px;
    }

    /* Invoice Modal Styles */
    .invoice-brand {
        font-family: 'Abhaya Libre', serif;
        font-size: 1.8rem;
        font-weight: 800;
        color: #212529;
        letter-spacing: 1px;
    }

    .invoice-details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 15px;
        margin-bottom: 25px;
        border: 2px solid #e9ecef;
    }

    .info-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #6c757d;
        font-weight: 700;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    .info-value {
        font-size: 1rem;
        color: #212529;
        font-weight: 600;
    }

    .invoice-table {
        width: 100%;
        margin: 25px 0;
        border-collapse: separate;
        border-spacing: 0;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        overflow: hidden;
    }

    .invoice-table thead {
        background: linear-gradient(135deg, #212529 0%, #495057 100%);
        color: white;
    }

    .invoice-table thead th {
        padding: 15px;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
    }

    .invoice-table tbody td {
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        vertical-align: top;
    }

    .invoice-table tbody tr:last-child td {
        border-bottom: none;
    }

    .invoice-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 15px;
        border-bottom: 1px solid #e9ecef;
        font-size: 0.95rem;
    }

    .summary-total {
        padding: 15px;
        background: linear-gradient(135deg, #212529 0%, #495057 100%);
        color: white;
        font-weight: 800;
        font-size: 1.2rem;
        border-radius: 10px;
        margin-top: 10px;
    }

    /* Record Modal Styles */
    .record-form-label {
        font-weight: 800;
        text-transform: uppercase;
        font-size: 0.85rem;
        color: #212529;
        min-width: 140px;
        letter-spacing: 0.5px;
    }

    .label-red {
        color: #dc3545;
    }

    .record-input-pill {
        flex: 1;
        padding: 12px 20px;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 25px;
        font-weight: 600;
        color: #495057;
        min-height: 45px;
        display: flex;
        align-items: center;
    }

    .record-input-red {
        flex: 1;
        padding: 12px 20px;
        background: #fff5f5;
        border: 2px solid #f8d7da;
        border-radius: 15px;
        font-weight: 600;
        color: #721c24;
        min-height: 45px;
    }

    .medicine-section-title {
        font-family: 'Abhaya Libre', serif;
        font-weight: 800;
        text-transform: uppercase;
        color: #212529;
        margin: 25px 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 3px solid #212529;
        letter-spacing: 1px;
    }

    .record-table-container {
        margin: 20px 0;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        overflow: hidden;
    }

    .record-table {
        width: 100%;
        margin: 0;
        border-collapse: collapse;
    }

    .record-table thead {
        background: linear-gradient(135deg, #198754 0%, #157347 100%);
        color: white;
    }

    .record-table thead th {
        padding: 12px;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
    }

    .record-table tbody td {
        padding: 12px;
        border-bottom: 1px solid #e9ecef;
        color: #495057;
    }

    .record-table tbody tr:last-child td {
        border-bottom: none;
    }

    .record-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .record-table tbody tr:nth-child(even) {
        background-color: #fafbfc;
    }

    /* Payment Badge Styles */
    .payment-status-paid {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        border: 2px solid #c3e6cb;
    }

    .payment-status-unpaid {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
        color: #856404;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        border: 2px solid #ffeeba;
    }

    footer#contact {
        display: none;
    }
</style>
{{/section}}

<div class="container-fluid my-4">
    <a href="javascript:history.back()" class="text-dark text-decoration-none"><i class="bi bi-arrow-left fs-4"></i></a>

    {{#if success}}
    <div class="alert alert-success alert-dismissible fade show rounded-3" role="alert">
        <i class="bi bi-check-circle me-2"></i> Action processed successfully!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {{/if}}

            <div class="content-section">
                <div class="content-header">
                    <h5 class="content-title mb-0">Appointment History</h5>
                    <div class="header-controls">
                        <select class="form-select filter-select" onchange="window.location.href = this.value">
                            <option value="/appointments" {{#unless currentFilter}}selected{{/unless}}>All</option>
                            <option value="/appointments?filter=upcoming" {{#if (eq currentFilter 'upcoming')}}selected{{/if}}>Upcoming</option>
                            <option value="/appointments?filter=past" {{#if (eq currentFilter 'past')}}selected{{/if}}>Past</option>
                        </select>
                        <button type="button" class="btn btn-outline-success btn-book-new" data-bs-toggle="modal" data-bs-target="#bookingModal">
                            <i class="bi bi-plus-lg"></i> Book
                        </button>
                    </div>
                </div>
                <div class="content-body">
                    {{#if appointments.length}}
                    <div class="table-responsive">
                        <table class="table custom-table">
                            <thead>
                                <tr>
                                    <th>Date - Time</th>
                                    <th>Pet</th>
                                    <th>Service</th>
                                    <th>Status</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each appointments}}
                                <tr>
                                    <td>
                                        <div class="fw-bold text-dark">{{date_start}}</div>
                                        <div class="small text-muted"><i class="bi bi-clock me-1"></i>{{time}}</div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-paw-fill me-2 text-secondary"></i>
                                            <span class="fw-600">{{pet_name}}</span>
                                        </div>
                                    </td>
                                    <td><span class="text-muted">{{#if services}}{{services}}{{else}}-{{/if}}</span></td>
                                    <td><span class="status-badge status-{{status}}">{{status}}</span></td>
                                    <td class="text-end">
                                        <div class="action-buttons justify-content-end">
                                            {{#if (eq status 'scheduled')}}
                                            <form method="POST" action="/appointments/cancel" class="d-inline" id="cancelForm_{{appointment_id}}">
                                                <input type="hidden" name="appointment_id" value="{{appointment_id}}">
                                                <button type="button" class="btn btn-action btn-delete" onclick="confirmCancel('{{appointment_id}}')">
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                            </form>
                                            {{/if}}
                                            {{#if (eq status 'completed')}}
                                            <button class="btn btn-action btn-edit me-1" data-bs-toggle="modal" data-bs-target="#invoiceModal" data-appointment-id="{{appointment_id}}" title="View Invoice">
                                                <i class="bi bi-receipt"></i>
                                            </button>
                                            <button class="btn btn-action btn-edit" data-bs-toggle="modal" data-bs-target="#recordModal" data-appointment-id="{{appointment_id}}" title="Medical Record">
                                                <i class="bi bi-file-medical"></i>
                                            </button>
                                            {{/if}}
                                        </div>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination Controls -->
                    <div class="pagination-wrapper mt-4" id="paginationControls"></div>
                    {{else}}
                    <div class="text-center py-5">
                        <i class="bi bi-calendar-x fs-1 text-muted"></i>
                        <p class="text-muted mt-3">No appointments found.</p>
                    </div>
                    {{/if}}
                </div>
            </div>
</div>

<div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 650px;">
        <div class="modal-content modal-content-custom">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title-custom mb-0">ELECTRONIC INVOICE</h5>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">‚úï</button>
            </div>
            <div class="modal-body p-4" id="invoiceContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted fw-bold">LOADING INVOICE...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="recordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 600px;">
        <div class="modal-content modal-content-custom shadow-lg">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title-custom mb-0">RECORD</h5>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">‚úï</button>
            </div>
            <div class="modal-body p-4" id="recordContent">
                <div class="text-center"><div class="spinner-border text-success"></div></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-custom" style="max-width: 500px; margin: auto;">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title-custom m-0">BOOKING FORM</h5>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">‚úï</button>
            </div>
            <div class="modal-body p-4">
                <form id="bookingForm" method="POST" action="/appointments/book">
                    <div class="mb-3">
                        <select class="form-select rounded-pill px-3" name="pet_id" required>
                            <option selected disabled>SELECT YOUR PET</option>
                            {{#each pets}}
                            <option value="{{this.pet_id}}">{{this.name}}</option>
                            {{/each}}
                        </select>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6"><input type="date" class="form-control rounded-pill" name="date_start" required></div>
                        <div class="col-6"><input type="time" class="form-control rounded-pill" name="time" required></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold text-uppercase text-muted" style="font-size: 0.9rem;">Select
                            Services:</label>
                        {{#if serviceList}}
                        <div
                            style="border: 2px solid #000; border-radius: 20px; padding: 20px 40px; background-color: #fff; max-height: 150px; overflow-y: auto;">
                            {{#each serviceList}}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="services"
                                    value="{{this.service_id}}" id="service_{{this.service_id}}">
                                <label class="form-check-label fw-bold" for="service_{{this.service_id}}">
                                    {{this.service_name}}
                                </label>
                            </div>
                            {{/each}}
                        </div>
                        {{else}}
                        <div class="alert alert-warning">No services available.</div>
                        {{/if}}
                    </div>
                    <textarea class="form-control mb-4" name="note" placeholder="Note something..." rows="3" style="border-radius: 15px;"></textarea>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">SUBMIT</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


{{#section 'js'}}
<script>
// ===== PAGINATION SETUP =====
const ITEMS_PER_PAGE = 4;
let currentPage = 1;
let allAppointments = [];

document.addEventListener('DOMContentLoaded', function() {
    // Get all appointment items
    const appointmentItems = document.querySelectorAll('.appointment-item');
    allAppointments = Array.from(appointmentItems);
    
    // Initialize pagination
    if (allAppointments.length > 0) {
        initializePagination();
        displayPage(1);
    }

    // ===== INVOICE AND RECORD MODALS =====
    const invoiceModal = document.getElementById('invoiceModal');
    if (invoiceModal) {
        invoiceModal.addEventListener('show.bs.modal', async function(event) {
            const button = event.relatedTarget;
            const appointmentId = button.getAttribute('data-appointment-id');
            const contentDiv = document.getElementById('invoiceContent');
            
            try {
                const response = await fetch('/appointments/' + appointmentId + '/invoice');
                const data = await response.json();
                
                if (data.success) {
                    const { appointment, services, summary, payment } = data;
                    
                    let servicesRows = services.map(s => `
                        <tr>
                            <td>
                                <strong style="color: #212529; font-size: 1rem;">${s.service_name}</strong><br>
                                <small class="text-muted" style="font-size: 0.85rem;">
                                    <i class="bi bi-tag-fill me-1"></i>Professional Pet Service
                                </small>
                            </td>
                            <td class="text-center" style="font-weight: 600;">1</td>
                            <td class="text-end" style="color: #6c757d;">${parseFloat(s.base_price).toLocaleString('vi-VN')} ƒë</td>
                            <td class="text-end" style="font-weight: 700; color: #212529; font-size: 1.05rem;">
                                ${parseFloat(s.base_price).toLocaleString('vi-VN')} ƒë
                            </td>
                        </tr>
                    `).join('');

                    contentDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start mb-4 pb-3" style="border-bottom: 3px solid #dee2e6;">
                            <div>
                                <h4 class="invoice-brand mb-1">PetCareUS</h4>
                                <p class="text-muted small mb-0" style="font-style: italic;">Quality health for your beloved pets</p>
                            </div>
                            <div class="text-end">
                                <div style="background: linear-gradient(135deg, #212529 0%, #495057 100%); color: white; padding: 10px 20px; border-radius: 10px; font-weight: 800; font-size: 1.1rem; letter-spacing: 1px;">
                                    #INV-${appointmentId.toString().padStart(4, '0')}
                                </div>
                                <p class="small text-muted mt-2 mb-0">
                                    <i class="bi bi-calendar-check me-1"></i>
                                    ${new Date().toLocaleDateString('vi-VN')}
                                </p>
                            </div>
                        </div>

                        <div class="invoice-details-grid">
                            <div>
                                <div class="info-label"><i class="bi bi-person-fill me-1"></i>Customer</div>
                                <div class="info-value">${appointment.customer_name}</div>
                                <div class="info-label mt-3"><i class="bi bi-paw-fill me-1"></i>Pet Name</div>
                                <div class="info-value" style="color: #198754;">${appointment.pet_name}</div>
                            </div>
                            <div>
                                <div class="info-label"><i class="bi bi-clock-fill me-1"></i>Appointment Time</div>
                                <div class="info-value">${new Date(appointment.date_start).toLocaleDateString('vi-VN')} ‚Ä¢ ${appointment.time}</div>
                                <div class="info-label mt-3"><i class="bi bi-clipboard2-pulse-fill me-1"></i>Veterinarian</div>
                                <div class="info-value" style="color: #0d6efd;">${appointment.veterinarian_name || 'Not Assigned'}</div>
                            </div>
                        </div>

                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-list-ul me-2"></i>Service Description</th>
                                    <th class="text-center" style="width: 80px;">Qty</th>
                                    <th class="text-end" style="width: 130px;">Unit Price</th>
                                    <th class="text-end" style="width: 150px;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>${servicesRows}</tbody>
                        </table>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="p-3" style="border: 2px solid #dee2e6; border-radius: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                                    <div class="info-label mb-3"><i class="bi bi-credit-card-fill me-1"></i>Payment Details</div>
                                    <div class="d-flex justify-content-between align-items-center mb-2 pb-2" style="border-bottom: 1px solid #dee2e6;">
                                        <span style="font-size: 0.9rem; color: #6c757d;">Method:</span>
                                        <span class="fw-bold" style="color: #212529; font-size: 0.95rem;">${payment.method}</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span style="font-size: 0.9rem; color: #6c757d;">Status:</span>
                                        <span class="payment-status-${payment.status}">${payment.status.toUpperCase()}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div style="border: 2px solid #dee2e6; border-radius: 15px; overflow: hidden;">
                                    <div class="summary-row">
                                        <span style="color: #6c757d;">Subtotal:</span>
                                        <span style="font-weight: 600;">$${summary.subtotal.toLocaleString('vi-VN')}</span>
                                    </div>
                                    <div class="summary-row" style="background-color: #fff5f5;">
                                        <span style="color: #dc3545;"><i class="bi bi-percent me-1"></i>Discount:</span>
                                        <span style="font-weight: 700; color: #dc3545;">- ${summary.discount.toLocaleString('vi-VN')}%</span>
                                    </div>
                                    <div class="summary-total d-flex justify-content-between">
                                        <span><i class="bi bi-cash-stack me-2"></i>TOTAL AMOUNT:</span>
                                        <span>$${summary.total.toLocaleString('vi-VN')}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        ${payment.status === 'unpaid' ? `
                        <div class="mt-4 p-4" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%); border: 2px solid #ffc107; border-radius: 15px;">
                            <form method="post" action="/appointments/invoice/pay/${payment.id}">
                                <div class="row align-items-end">
                                    <div class="col-md-7">
                                        <label class="form-label fw-bold text-uppercase" style="font-size: 0.85rem; color: #856404; letter-spacing: 0.5px;">
                                            <i class="bi bi-credit-card-2-front me-2"></i>Select Payment Method
                                        </label>
                                        <select class="form-select" name="payment_method" required style="border: 2px solid #856404; border-radius: 12px; padding: 12px; font-weight: 600;">
                                            <option value="" disabled selected>Choose payment method...</option>
                                            <option value="CASH">üíµ Cash Payment</option>
                                            <option value="CREDIT_CARD">üí≥ Credit Card</option>
                                            <option value="DEBIT_CARD">üí≥ Debit Card</option>
                                            <option value="BANK_TRANSFER">üè¶ Bank Transfer</option>
                                            <option value="E_WALLET">üì± E-Wallet</option>
                                        </select>
                                    </div>
                                    <div class="col-md-5">
                                        <button type="submit" class="btn btn-success w-100 fw-bold py-3" style="border-radius: 12px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.95rem;">
                                            <i class="bi bi-check-circle-fill me-2"></i>Complete Payment
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        ` : ''}
                        
                        <div class="text-center mt-4 pt-3" style="border-top: 2px dashed #dee2e6;">
                            <p class="text-muted small mb-1" style="font-style: italic;">
                                <i class="bi bi-heart-fill text-danger me-1"></i>
                                Thank you for trusting PETCARE X with your beloved pet's health!
                            </p>
                            <p class="text-muted" style="font-size: 0.75rem;">
                                For inquiries: petcareus.notify@gmail.com
                            </p>
                        </div>
                    `;
                } else {
                    contentDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Error loading invoice data.</div>';
                }
            } catch (e) {
                contentDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-wifi-off me-2"></i>Connection error. Please try again.</div>';
            }
        });
    }

    const recordModal = document.getElementById('recordModal');
    if (recordModal) {
        recordModal.addEventListener('show.bs.modal', async function(event) {
            const appointmentId = event.relatedTarget.getAttribute('data-appointment-id');
            const content = document.getElementById('recordContent');
            
            try {
                const res = await fetch(`/appointments/${appointmentId}/record`);
                const data = await res.json();
                
                if (data.success) {
                    const { medicines, medicine_records } = data;
                    let medicineRows = medicines.map((m, index) => `
                        <tr>
                            <td style="font-weight: 700; color: #212529;">${index + 1}</td>
                            <td style="font-weight: 600; color: #495057;">${m.medicine_name}</td>
                            <td><span style="background: #e9ecef; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${m.form}</span></td>
                            <td style="color: #6c757d; font-size: 0.9rem;">${m.description}</td>
                        </tr>
                    `).join('');

                    content.innerHTML = `
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <label class="record-form-label"><i class="bi bi-calendar-event me-2"></i>DATE:</label>
                                <div class="record-input-pill">${new Date(medicine_records.visit_date).toLocaleDateString('vi-VN')}</div>
                            </div>
                            <div class="d-flex align-items-center mb-3">
                                <label class="record-form-label"><i class="bi bi-clipboard2-pulse me-2"></i>TREATMENT:</label>
                                <div class="record-input-pill">${medicine_records.treatment || 'N/A'}</div>
                            </div>
                            <div class="d-flex align-items-center mb-3">
                                <label class="record-form-label"><i class="bi bi-activity me-2"></i>SYMPTOM:</label>
                                <div class="record-input-pill">${medicine_records.symptoms || 'N/A'}</div>
                            </div>
                        </div>

                        <h5 class="medicine-section-title">
                            <i class="bi bi-capsule me-2"></i>Prescribed Medicines
                        </h5>
                        <div class="record-table-container">
                            <table class="record-table">
                                <thead>
                                    <tr>
                                        <th style="width: 60px;">No.</th>
                                        <th>Medicine Name</th>
                                        <th style="width: 120px;">Form</th>
                                        <th>Usage Instructions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${medicineRows || '<tr><td colspan="4" class="text-center text-muted py-4"><i class="bi bi-inbox me-2"></i>No medicine prescribed.</td></tr>'}
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4 p-3" style="background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%); border: 2px solid #f8d7da; border-radius: 15px;">
                            <div class="mb-3">
                                <label class="record-form-label label-red"><i class="bi bi-file-medical-fill me-2"></i>DIAGNOSIS:</label>
                                <div class="record-input-red">${medicine_records.diagnosis || 'N/A'}</div>
                            </div>
                            <div>
                                <label class="record-form-label label-red"><i class="bi bi-chat-left-text-fill me-2"></i>INSTRUCTION:</label>
                                <div class="record-input-red" style="min-height: 80px; white-space: pre-wrap;">${medicine_records.instruction || 'N/A'}</div>
                            </div>
                        </div>

                        <div class="text-center mt-3 pt-2" style="border-top: 2px dashed #dee2e6;">
                            <p class="text-muted small mb-0" style="font-style: italic;">
                                <i class="bi bi-shield-fill-check text-success me-1"></i>
                                Medical record verified and approved by veterinarian
                            </p>
                        </div>
                    `;
                } else {
                    content.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Error loading medical record.</div>`;
                }
            } catch (e) {
                content.innerHTML = `<div class="alert alert-danger"><i class="bi bi-wifi-off me-2"></i>Connection error. Please try again.</div>`;
            }
        });
    }
});

// ===== PAGINATION FUNCTIONS =====
function initializePagination() {
    const totalPages = Math.ceil(allAppointments.length / ITEMS_PER_PAGE);
    const controlsContainer = document.getElementById('paginationControls');
    
    if (totalPages <= 1) return;
    
    // Previous Button
    const prevBtn = document.createElement('button');
    prevBtn.className = 'pagination-btn';
    prevBtn.innerHTML = '<i class="bi bi-chevron-left"></i>';
    prevBtn.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            displayPage(currentPage);
            updatePaginationButtons();
        }
    };
    controlsContainer.appendChild(prevBtn);

    // Page Buttons
    for (let i = 1; i <= totalPages; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = 'pagination-btn';
        if (i === currentPage) pageBtn.classList.add('active');
        pageBtn.textContent = i;
        pageBtn.onclick = () => {
            currentPage = i;
            displayPage(currentPage);
            updatePaginationButtons();
        };
        controlsContainer.appendChild(pageBtn);
    }

    // Next Button
    const nextBtn = document.createElement('button');
    nextBtn.className = 'pagination-btn';
    nextBtn.innerHTML = '<i class="bi bi-chevron-right"></i>';
    nextBtn.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            displayPage(currentPage);
            updatePaginationButtons();
        }
    };
    controlsContainer.appendChild(nextBtn);

    // Info Text
    const infoSpan = document.createElement('span');
    infoSpan.className = 'pagination-info';
    infoSpan.id = 'paginationInfo';
    infoSpan.textContent = `1 - ${Math.min(ITEMS_PER_PAGE, allAppointments.length)} of ${allAppointments.length}`;
    controlsContainer.appendChild(infoSpan);
}

function confirmCancel(appointmentId) {
    Swal.fire({
        title: 'Cancel Appointment?',
        text: 'Are you sure you want to cancel this appointment?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Cancel',
        cancelButtonText: 'No, Keep It',
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('cancelForm_' + appointmentId).submit();
        }
    });
}

function displayPage(pageNum) {
    const start = (pageNum - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;

    allAppointments.forEach((item, index) => {
        item.style.display = (index >= start && index < end) ? 'block' : 'none';
    });

    // Update info text
    const infoSpan = document.getElementById('paginationInfo');
    if (infoSpan) {
        const displayStart = start + 1;
        const displayEnd = Math.min(end, allAppointments.length);
        infoSpan.textContent = `${displayStart} - ${displayEnd} of ${allAppointments.length}`;
    }

    // Scroll to top of appointments
    document.getElementById('appointmentsContainer')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function updatePaginationButtons() {
    const totalPages = Math.ceil(allAppointments.length / ITEMS_PER_PAGE);
    const buttons = document.querySelectorAll('.pagination-btn');
    
    buttons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === currentPage.toString()) {
            btn.classList.add('active');
        }
    });
}
</script>
{{/section}}